# DEV_LOG_20251208.md - Troubleshooting Notia White Screen Issue

**Date:** 2025년 12월 8일 월요일

## 배경
사용자가 Tauri 기반의 Notia 앱 빌드 후 **흰 화면**이 지속되는 문제를 보고했습니다. 이 문제는 웹 배포 버전에서도 재현되기도 했습니다.

---

## 작업 내용 요약 (타임라인)

### v1.3.2 -> v1.3.3: CI Supabase 환경 변수 주입 시도

*   **문제**: 앱 흰 화면. CI (`.github/workflows/tauri-build.yml`)에서 Supabase 환경 변수 `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`가 누락되어 초기화 실패로 추정. CI `APP_VERSION` 스크립트의 Windows 호환성 문제도 의심.
*   **해결 시도**:
    *   `.github/workflows/tauri-build.yml`에 `tauri-apps/tauri-action` 스텝의 `env` 섹션에 Supabase 환경 변수 추가.
    *   `Get app version` 스텝에 `shell: bash` 명시하여 Windows 호환성 확보.
*   **결과**: 문제 해결되지 않음.

### v1.3.3 -> v1.3.4: CI .env 파일 생성 및 Supabase 에러 화면 추가

*   **문제**: 여전히 흰 화면. `v1.3.3`에서 추가한 환경 변수가 빌드 과정에 제대로 전달되지 않았을 가능성. JS 에러 발생 시 사용자에게 흰 화면 대신 에러를 보여주도록 요청.
*   **해결 시도**:
    *   `.github/workflows/tauri-build.yml`에 `Create .env file` 스텝을 추가하여 Supabase 환경 변수를 직접 `.env` 파일로 생성. Vite는 빌드 시 `.env` 파일을 로드.
    *   `src/services/supabaseClient.ts`에 Supabase 환경 변수 누락 시 `document.body`에 에러 메시지를 표시하는 코드 추가 (Red Screen of Death - RSOD).
*   **결과**: 문제 해결되지 않음. RSOD 화면조차 뜨지 않음. (JS 실행 전에 문제가 발생함을 시사)

### v1.3.4 -> v1.3.5: `main.tsx`에 전역 에러 핸들러 추가

*   **문제**: RSOD조차 뜨지 않는 흰 화면. JS 런타임 에러가 발생하더라도 사용자에게 즉시 피드백을 제공하도록 요청.
*   **해결 시도**:
    *   `src/main.tsx` 최상단에 `window.onerror` 및 `window.onunhandledrejection` 전역 에러 핸들러 추가하여 어떤 JS 에러든 화면에 표시하도록 함.
*   **결과**: 문제 해결되지 않음. 여전히 흰 화면. (HTML/JS 로딩 자체에 문제가 있음을 강하게 시사)

### v1.3.5 -> v1.3.6: `index.html`에 인라인 에러 핸들러 추가

*   **문제**: `main.tsx`의 전역 에러 핸들러조차 뜨지 않는 흰 화면. HTML 파일 로딩 중 리소스(JS/CSS) 로딩 실패 가능성.
*   **해결 시도**:
    *   `index.html` `<head>` 태그 내에 인라인 스크립트로 강력한 에러 핸들러 추가. 리소스 로딩 에러(`window.addEventListener('error', ..., true)`)까지 캡처하도록 함.
*   **결과**: 문제 해결되지 않음. 여전히 흰 화면.

### v1.3.6 -> v1.3.7: Tauri 호환성을 위한 경로/라우터 변경 시도

*   **문제**: 흰 화면 문제 지속. 웹 배포도 문제가 발생하기 시작. Tauri 앱이 `file://` 프로토콜을 사용하므로 `base: '/'` (절대 경로)가 JS/CSS 로딩 문제를 일으킬 것으로 의심.
*   **해결 시도**:
    *   `vite.config.ts`: `base: '/'` -> `base: './'` (상대 경로).
    *   `src/App.tsx`: `createBrowserRouter` -> `createHashRouter` (Tauri 호환).
*   **결과**: 웹과 앱 모두 정상 작동하지 않음.

### v1.3.7 -> v1.3.8: 웹/앱 빌드 전략 분리 시도 (1차)

*   **문제**: `v1.3.7` 변경 후 웹과 앱 모두 작동하지 않는 문제. 각 환경에 맞는 빌드 설정이 필요함을 인지.
*   **해결 시도**:
    *   `package.json`: `build:tauri` 스크립트 추가 (`vite build --base ./` 및 `VITE_IS_TAURI=true` 사용).
    *   `tauri.conf.json`: `beforeBuildCommand`를 `npm run build:tauri`로 변경.
    *   `src/App.tsx`: `VITE_IS_TAURI` 환경 변수를 기준으로 `createBrowserRouter`와 `createHashRouter`를 조건부 선택.
*   **결과**: 문제 해결되지 않음. 웹과 앱 모두 여전히 흰 화면.

### v1.3.8 -> v1.3.9: 빌드 전략 분리 변경 사항 롤백

*   **문제**: `v1.3.8` 변경 후에도 웹/앱 모두 작동하지 않음. 사용자가 기존 상태로 롤백 요청.
*   **해결 시도**: `v1.3.8`에서 적용했던 빌드 스크립트 분리, 라우터 조건부 선택 등의 로직을 모두 롤백.
*   **결과**: 웹과 앱 모두 여전히 흰 화면.

### v1.3.9 -> v1.3.10: 통합 빌드 전략 시도 (2차, `mode` 활용)

*   **문제**: `v1.3.9` 롤백 후에도 웹/앱 모두 작동하지 않음. `v1.3.8`의 전략을 Vite의 `mode` 기능을 활용하여 더 견고하게 구현 시도.
*   **해결 시도**:
    *   `vite.config.ts`: 함수형 설정으로 변경, `mode === 'tauri'`일 때 `base: './'`, 아니면 `'/'`.
    *   `src/App.tsx`: `import.meta.env.MODE === 'tauri'`를 기준으로 라우터 조건부 선택.
    *   `package.json`: `build:tauri` 스크립트 수정 (`--mode tauri`).
    *   `tauri.conf.json`: `beforeBuildCommand`를 `npm run build:tauri`로 변경.
*   **결과**: 문제 해결되지 않음. 웹과 앱 모두 여전히 흰 화면.

### v1.3.10 -> v1.3.11: 통합 빌드 전략 단순화 및 `index.html` 정리

*   **문제**: `v1.3.10` 변경 후에도 웹/앱 모두 작동하지 않음. 이전 시도들이 너무 복잡했을 수 있음을 인지. `index.html`에 추가했던 인라인 에러 핸들러가 잠재적인 충돌 원인일 수 있음.
*   **해결 시도**:
    *   `index.html`: 인라인 에러 핸들러 제거하여 깔끔한 상태로 복구.
    *   `vite.config.ts`: `base: './'`로 고정.
    *   `src/App.tsx`: `createHashRouter`로 고정.
    *   `package.json`: `build:tauri` 제거하고 `build` 스크립트 하나로 통일.
*   **결과**: 빌드 시 `vite.config.ts`에서 "packageJson" 심볼 중복 선언 에러 발생 (빌드 실패). (이전 수정 과정에서 발생한 제 실수)

### v1.3.11 -> v1.3.12: `vite.config.ts` 중복 선언 에러 수정

*   **문제**: `v1.3.11` 빌드 실패(`packageJson` 중복 선언).
*   **해결 시도**: `vite.config.ts` 파일 내용을 올바르게 정리하여 중복 선언을 제거.
*   **결과**: 빌드 에러는 해결되었으나, 여전히 웹과 앱 모두 흰 화면.

### v1.3.12 -> v1.3.13: 웹 배포 버전 복구 요청 (현재 상태)

*   **문제**: `v1.3.12` 빌드 성공에도 불구하고 웹/앱 모두 흰 화면. 사용자가 웹 배포 버전이라도 원래대로 작동하도록 복구 요청.
*   **해결 시도**:
    *   `vite.config.ts`: `base: '/'`로 원복.
    *   `src/App.tsx`: `createBrowserRouter`로 원복.
    *   `package.json` 및 `tauri.conf.json`: 표준 빌드 설정 복구.
*   **결과**: 웹에서 `Failed to fetch dynamically imported module: https://notia.site/assets/platforms/web/index.tsx` 404 에러 발생. 여전히 흰 화면. 브라우저가 `.tsx` 파일을 요청하는 문제 확인.

### v1.3.13 -> v1.3.14: 동적 임포트 404 에러 (`.tsx` 요청) 수정 (1차)

*   **문제**: 웹에서 `https://notia.site/assets/platforms/web/index.tsx` 파일 404 에러. 번들러가 `.tsx` 파일을 제대로 처리하지 못하고 브라우저가 소스 파일 경로를 요청.
*   **해결 시도**:
    *   `src/main.tsx`의 동적 임포트 `import(\`./platforms/${platformName}/index.tsx\`)
`를 `switch` 문과 정적 문자열 `import('./platforms/web/index.tsx')`로 변경하여 번들러가 정확히 인식하도록 함.
*   **결과**: 여전히 동일한 `https://notia.site/assets/platforms/web/index.tsx` 404 에러 발생.

### v1.3.14 -> v1.3.15: 동적 임포트 404 에러 수정 (2차, `manualChunks` 제거 및 Alias 활용)

*   **문제**: `v1.3.14` 수정 후에도 동일한 `.tsx` 404 에러 지속. `vite.config.ts`의 `manualChunks` 설정이 동적 임포트 처리와 충돌하여 문제를 일으킬 것으로 의심.
*   **해결 시도**:
    *   `vite.config.ts`에서 `build.rollupOptions.output.manualChunks` 제거하여 Vite의 기본 청킹 전략 사용.
    *   `src/main.tsx`의 동적 임포트 경로를 `@/platforms/...` (alias)를 사용하도록 변경하여 번들러가 정확히 인식하도록 함.
*   **결과**: 여전히 웹과 앱 모두 흰 화면. 동일한 `https://notia.site/assets/platforms/web/index.tsx` 404 에러 발생.

### v1.3.15 -> v1.3.16: 정적 임포트 전환 및 빌드 검증

*   **문제**: 동적 임포트가 번들링 과정에서 제대로 처리되지 않아 런타임에 소스 파일(`.tsx`)을 찾는 문제가 지속됨.
*   **해결 시도**:
    *   `src/main.tsx`: `initializePlatform` 내부의 동적 임포트를 제거하고, 상단에서 모든 플랫폼 모듈(`@/platforms/web/index.tsx` 등)을 `import * as ...`로 **정적 임포트**하도록 변경.
    *   런타임에는 `platformModules` 맵을 통해 필요한 모듈을 선택하여 실행.
    *   **빌드 검증**: 로컬 `npm run build` 수행 후 `dist/assets` 디렉토리 확인.
*   **결과**:
    *   `dist/assets` 내에 `.tsx` 파일이 포함되지 않고, 모든 코드가 정상적으로 JS 청크(`index-*.js`, `activityCalculator-*.js` 등)로 번들링됨을 확인.
    *   `dist/index.html`이 올바른 진입점 JS 파일을 참조하고 있음.
    *   번들링 문제는 해결된 것으로 판단됨.

### v1.3.16 -> v1.3.17: Tauri 호환성을 위한 라우터/경로 재설정

*   **문제**: `v1.3.16`에서 번들링 문제는 해결되었으나, 사용자가 여전히 흰 화면 문제 지속을 보고함. `createBrowserRouter`와 `base: '/'` 설정이 Tauri 환경(또는 일부 웹 호스팅 환경)에서 라우팅 문제를 일으키는 것으로 판단됨.
*   **해결 시도**:
    *   `src/App.tsx`: `createBrowserRouter` -> **`createHashRouter`**로 변경. (Tauri 및 정적 호스팅에서 가장 안정적인 방식)
    *   `vite.config.ts`: `base: '/'` -> **`base: './'`**로 변경. (상대 경로 리소스 로딩 보장)
*   **기대 효과**:
    *   번들링 문제 해결(`v1.3.16`) + 라우팅 안정성 확보(`v1.3.17`)를 통해 흰 화면 문제의 두 가지 주요 원인을 모두 제거.
    *   `/#/` URL을 사용하게 되지만, 앱 실행의 안정성이 우선임.

### v1.3.17 -> v1.3.18: Tauri 보안 정책(CSP) 강화 및 런타임 디버깅 추가

*   **문제**: `npm run preview`를 통해 확인한 결과, 웹 빌드 자체는 정상적으로 화면이 출력됨. 따라서 React 코드나 번들링 문제가 아님. **Tauri Webview 환경에서만 발생하는 보안 정책(CSP) 또는 런타임 에러**가 원인으로 좁혀짐.
*   **해결 시도**:
    1.  **CSP(Content Security Policy) 명시**: `src-tauri/tauri.conf.json`의 `csp` 설정을 `default-src 'self' ...` 형태로 구체화하여, Tauri가 로컬 스크립트와 스타일을 안전하게 로드하도록 허용.
    2.  **`alert` 디버깅 추가**: `src/main.tsx`의 전역 에러 핸들러(`onerror`, `onunhandledrejection`)에 `window.alert()`를 추가.
*   **결과**: 알림창이 뜨지 않고 여전히 흰 화면. 이는 **JS 실행 전 단계**에서 리소스 로딩이 실패하고 있음을 강력하게 시사.

### v1.3.18 -> v1.3.19: 강력한 인라인 에러 핸들러 주입

*   **문제**: `v1.3.18`에서 추가한 JS 에러 핸들러가 작동하지 않음. 즉, 번들된 JS 파일 자체가 로드되지 않았거나(404), 차단됨.
*   **해결 시도**:
    *   `index.html`: `<head>` 최상단에 **인라인 스크립트**로 에러 핸들러를 직접 주입.
    *   `window.addEventListener('error', ..., true)` (Capture Phase)를 사용하여 `<script src="...">` 태그의 로딩 실패까지 감지하도록 설정.
    *   에러 발생 시 무조건 `window.alert`를 띄우도록 함.
*   **목표**: 흰 화면이 뜰 때 반드시 알림창을 띄워, "어떤 파일"이 로드되지 않았는지(예: `Failed to load resource: ./assets/index.js`) 확인.