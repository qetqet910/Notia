# 디버깅 및 수정 작업 로그 (2025-07-27)

## 1. 최초 문제

- 새로 생성된 키(key)로 로그인이 되지 않는 문제 발생.
- 사용자는 "사용자 생성 시의 비밀번호 규칙과 로그인 시의 비밀번호 규칙이 서로 달라서 발생한 문제"로 추정.
- 구체적으로, 키 길이가 6자 미만일 때 Edge Function에서는 `-notia-key`를 붙여 저장하지만, 클라이언트에서는 붙이지 않아 불일치가 발생한다고 언급.

## 2. 1차 진단 및 시도

- **Edge Function 확인:** `list_edge_functions`로 실제 배포된 `create_email_user` 함수를 확인.
- **분석:** 사용자가 언급한 대로, 키 길이가 6자 미만일 경우 비밀번호에 `-notia-key`를 추가하는 로직이 실제로 존재했음. 또한, 사용자가 이미 존재할 경우의 로그인 처리 로직에 원래 키(`key`)로 다시 로그인하는 비정상적인 폴백(fallback) 코드가 포함되어 있어 혼란을 야기할 수 있음을 발견.
- **수정:** `create_email_user` 함수에서 이중 폴백 로그인 로직을 제거하여 비밀번호 규칙을 명확히 함.

## 3. 2차 문제 발생 및 진단

- **오류 발생:** 1차 수정 이후, 로그인 시 `유효하지 않은 키입니다.` 라는 오류가 발생.
- **원인 분석:**
  - 클라이언트와 서버 간에 키를 처리하는 방식(하이픈 제거, 대문자 변환 등)이 통일되지 않았을 가능성.
  - `-notia-key` 접미사 규칙 자체가 혼란의 원인이라고 판단.

## 4. 2차 해결 시도 (전면적인 규칙 개편)

- **새로운 규칙 수립:**

  1.  **키 규칙 통일:** 모든 키는 하이픈(-)을 제거하고 대문자로 변환 (`cleanKey`).
  2.  **최소 길이(6자) 적용:** 변환된 키는 항상 6자 이상이어야 한다는 규칙을 새로 적용.
  3.  **`-notia-key` 접미사 완전 제거:** 더 이상 비밀번호 길이를 맞추기 위한 접미사를 사용하지 않음.

- **Edge Function 수정:**

  - `create_email_user`, `create_anonymous_user` 두 함수 모두 새로운 키 규칙(6자 이상)을 적용하고, `-notia-key` 로직을 제거.

- **클라이언트 코드 수정:**
  - `authStore.ts`: `loginWithKey` 함수에서 `-notia-key` 로직을 제거하고, 항상 변환된 `cleanKey`를 비밀번호로 사용하도록 수정.
  - `keyValidation.ts`: 키 유효성 검사 로직을 "6자 이상" 규칙에 맞게 수정하고, 상세한 오류 메시지를 반환하는 `validateKey` 함수를 추가.
  - `inputOtpControl.tsx`: `validateKey`를 사용하여 사용자에게 실시간 유효성 검사 피드백을 제공하도록 UI 개선.

## 5. 3차 문제 발생 (연쇄 오류)

2차 수정 이후, 다음과 같은 여러 오류가 연쇄적으로 발생:

1.  **Lottie 애니메이션 오류:** `Login.tsx`에서 Lottie 파일을 불러오지 못하는 문제.
    - **원인:** `src`에 문자열 경로를 직접 전달하여 Vite 개발 서버에서 파일을 제대로 처리하지 못함.
    - **해결:** Lottie 파일을 `?raw`로 직접 import하고, `data` 속성으로 전달하여 해결.
2.  **정규식 패턴 오류:** `inputOtpControl.tsx`의 `pattern` 속성값이 최신 브라우저에서 오류 발생.
    - **원인:** `[A-Z0-9-]*` 패턴이 일부 브라우저에서 유효하지 않음.
    - **해결:** 핵심 기능이 아니므로 `pattern` 속성을 제거하여 해결.
3.  **`e2` 속성 오류:** `input-otp.tsx`에서 `e2`라는 잘못된 속성 사용 오류.
    - **원인:** `inputOtpControl.tsx` 수정 중 발생한 명백한 오타.
    - **해결:** 오타를 제거하여 해결.
4.  **자동 로그인 불가:** 키를 모두 입력해도 로그인이 자동으로 실행되지 않는 문제.
    - **원인:** 로그인 로직이 `InputOTPControlled` 컴포넌트 내부에 캡슐화되면서, 부모인 `Login.tsx`의 폼(form)과 연동이 끊어짐.
    - **해결:** 상태와 핸들러를 부모인 `Login.tsx`로 끌어올려(lifting state up) 폼 제출 로직을 중앙에서 관리하도록 수정.

## 6. 최종 결정: 전체 롤백

- 연쇄적인 문제 발생으로 인해, 최초의 문제가 다른 곳에 있을 수 있다는 사용자의 의견을 수렴.
- 디버깅을 원점에서 다시 시작하기 위해, 지금까지 변경된 모든 **로컬 파일**과 **Edge Function**을 원래 상태로 복원하기로 결정.